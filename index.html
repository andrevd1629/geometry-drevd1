<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GEOMETRY DREVD: LOGOUT FIXED</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@900&family=VT323&display=swap');

        body {
            margin: 0;
            background-color: #050505;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: white;
            font-family: 'Roboto', sans-serif;
            overflow: hidden;
            user-select: none;
            touch-action: none;
        }

        #game-wrapper {
            position: relative;
            width: 800px;
            height: 450px;
            box-shadow: 0 0 60px rgba(0, 100, 255, 0.3);
            border: 2px solid #333;
            background: #000;
        }

        canvas { display: block; width: 100%; height: 100%; }

        /* UI */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(0, 0, 0, 0.95); z-index: 20;
            backdrop-filter: blur(5px); transition: opacity 0.3s;
        }
        .hidden { display: none !important; opacity: 0; pointer-events: none; }

        h1 {
            font-family: 'Orbitron', sans-serif; font-size: 50px; margin-bottom: 10px; color: #fff;
            text-shadow: 0 0 10px #00e5ff, 0 0 30px #0055ff; text-align: center;
        }

        /* STATS HEADER */
        .stats-bar {
            display: flex; gap: 20px; font-family: 'Orbitron'; font-size: 20px; color: #ffd700;
            margin-bottom: 20px; text-shadow: 0 0 5px #ffd700;
        }

        #death-msg { color: #ff3333; text-shadow: 0 0 20px #ff0000; font-size: 40px; margin-bottom: 20px; }

        button {
            border: 1px solid #555; padding: 12px 25px; font-size: 16px; font-weight: bold; color: #eee;
            cursor: pointer; border-radius: 5px; text-transform: uppercase; margin: 8px; transition: 0.2s;
            font-family: 'Orbitron', sans-serif;
        }
        button:hover { transform: scale(1.05); filter: brightness(1.2); }
        .btn-menu { background: #333; }
        .btn-garage { background: linear-gradient(45deg, #11998e, #38ef7d); border:none; color:#fff; }
        .btn-achieve { background: linear-gradient(45deg, #ff9966, #ff5e62); border:none; color:#fff; }
        
        /* Special Buttons */
        .btn-secret { position: absolute; bottom: 15px; right: 15px; background: transparent; border: 1px solid #444; color: #555; font-size: 24px; padding: 5px 12px; z-index: 100; }
        .btn-secret:hover { color: red; border-color: red; }
        
        #btn-auth { 
            position: absolute; top: 15px; left: 15px; 
            background: transparent; border: 1px solid #00e5ff; color: #00e5ff; 
            font-size: 14px; padding: 8px 15px; z-index: 100; 
            box-shadow: 0 0 10px rgba(0, 229, 255, 0.2);
        }
        #btn-auth:hover { background: rgba(0, 229, 255, 0.1); }

        /* Level Grid */
        .level-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 85%; max-width: 600px; max-height: 200px; overflow-y: auto; margin-bottom: 10px; padding-right: 5px; }
        .level-card { background: #1a1a1a; padding: 15px; border: 1px solid #444; cursor: pointer; display: flex; flex-direction: column; transition: 0.2s; border-radius: 6px; }
        .level-card:hover { background: #252525; border-color: #ffd700; transform: translateY(-2px); }
        .lvl-header { display: flex; justify-content: space-between; font-weight: bold; }
        .lvl-sub { font-size: 12px; color: #888; margin-top: 5px; display: flex; justify-content: space-between; }

        .diff-Easy { color: #2ecc71; }
        .diff-Normal { color: #f1c40f; }
        .diff-Hard { color: #e67e22; }
        .diff-Insane { color: #ff0055; text-shadow: 0 0 5px #ff0055; }

        /* MENUS */
        .garage-container { display: flex; flex-direction: column; gap: 15px; background: rgba(20,20,20,0.95); padding: 25px; border-radius: 10px; border: 1px solid #444; }
        .selection-row { display: flex; gap: 10px; justify-content: center; align-items: center; flex-wrap: wrap; }
        .color-btn { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid #444; margin: 2px; }
        .color-btn.active { border-color: #fff; transform: scale(1.2); box-shadow: 0 0 10px #fff; }
        .skin-btn { width: 50px; height: 50px; border: 2px solid #444; background: #111; cursor: pointer; position: relative; display: flex; justify-content: center; align-items: center; }
        .skin-btn.active { border-color: #0f0; box-shadow: 0 0 10px #0f0; }
        .skin-btn.locked { opacity: 0.5; cursor: not-allowed; }
        .skin-btn.locked::after { content: 'üîí'; position: absolute; font-size: 20px; }

        /* INPUT FIELDS */
        .pass-input { 
            background: #111; border: 1px solid #00e5ff; color: #00e5ff; 
            font-family: 'Orbitron'; font-size: 20px; text-align: center; 
            padding: 10px; margin: 5px; width: 250px;
        }
        .pass-input::placeholder { color: #005555; }

        /* CHEAT MENU */
        #cheatMenu { background: rgba(0, 20, 0, 0.98); font-family: 'VT323', monospace; color: #0f0; }
        .cheat-box { border: 1px solid #0f0; padding: 20px; width: 70%; display: flex; flex-direction: column; gap: 8px; box-shadow: 0 0 20px rgba(0, 255, 0, 0.2); }
        .cheat-row { display: flex; justify-content: space-between; font-size: 20px; border-bottom: 1px solid #004400; padding-bottom: 2px;}
        .cheat-toggle { cursor: pointer; color: #555; font-weight: bold; }
        .cheat-toggle.on { color: #0f0; text-shadow: 0 0 5px #0f0; }
        .cheat-btn { cursor: pointer; color: #0ff; text-decoration: underline; }

        /* Editor & Mobile */
        #editor-ui { position: absolute; top: 10px; left: 10px; right: 10px; display: flex; justify-content: space-between; pointer-events: none; }
        #editor-ui button { pointer-events: auto; padding: 5px 10px; margin-right: 5px; background: #fff; color: #000; border: none; }
        .info { pointer-events: auto; background: rgba(0,0,0,0.8); padding: 5px; color: #aaa; border-radius: 4px; font-size: 12px; }
        #mobile-play-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; touch-action: none; }
        #mob-pause { position: absolute; top: 10px; right: 10px; width: 50px; height: 50px; border-radius: 5px; font-size: 12px; pointer-events: auto; background: rgba(255,255,255,0.2); border: 2px solid white; color: white;}
        #mob-editor-controls { position: absolute; bottom: 10px; left: 0; width: 100%; display: flex; justify-content: center; gap: 20px; pointer-events: none; }
        #mob-editor-controls button { pointer-events: auto; width: 60px; height: 60px; font-size: 24px; background: rgba(0,0,0,0.5); color: white; border: 1px solid white; border-radius: 50%; }

    </style>
</head>
<body>

<audio id="bgMusic" loop></audio>

<div id="game-wrapper">
    <canvas id="gameCanvas" width="800" height="450"></canvas>
    
    <!-- MAIN MENU -->
    <div id="mainMenu" class="overlay">
        <h1>GEOMETRY DREVD 2.1</h1>
        
        <div class="stats-bar">
            <span>‚≠ê <span id="star-count">0</span></span>
            <span>üü° <span id="coin-count">0</span></span>
        </div>

        <div id="level-list" class="level-grid"></div>
        <div style="display:flex; flex-wrap: wrap; justify-content: center;">
            <button class="btn-garage" onclick="openGarage()">üé® –ì–ê–†–ê–ñ</button>
            <button class="btn-achieve" onclick="openAchievements()">üèÜ –î–û–°–¢–ò–ñ–ï–ù–ò–Ø</button>
            <button class="btn-menu" onclick="openSlotsMenu(false)">üõ† –†–ï–î–ê–ö–¢–û–†</button>
            <button class="btn-menu" onclick="openSettings()">‚öô –ù–ê–°–¢–†–û–ô–ö–ò</button>
        </div>
        
        <!-- –ö–ù–û–ü–ö–ê –í–•–û–î–ê/–í–´–•–û–î–ê -->
        <button id="btn-auth" onclick="handleAuth()">üë§ LOG IN</button>
        
        <!-- –°–ï–ö–†–ï–¢–ù–ê–Ø –ö–ù–û–ü–ö–ê -->
        <button class="btn-secret" onclick="openPasswordMenu()">üîí</button>
    </div>

    <!-- ACCOUNT MENU (LOG IN) -->
    <div id="accountMenu" class="overlay hidden">
        <h1>ACCOUNT LOGIN</h1>
        <div class="garage-container" style="align-items: center;">
            <input type="text" id="accName" class="pass-input" placeholder="USERNAME">
            <input type="password" id="accPass" class="pass-input" placeholder="PASSWORD">
            <div id="accMsg" style="height: 20px; color: red; font-family: 'Orbitron';"></div>
        </div>
        <div style="display: flex;">
            <button class="btn-menu" onclick="loginAccount()" style="border-color:#0f0; color:#0f0">ENTER</button>
            <button class="btn-menu" onclick="closeAccountMenu()">CANCEL</button>
        </div>
    </div>

    <!-- PIN MENU -->
    <div id="pinMenu" class="overlay hidden">
        <h1>SECURITY CHECK</h1>
        <div class="garage-container" style="align-items: center;">
            <p style="color:#00e5ff; font-family:'Orbitron'">ENTER PIN CODE:</p>
            <input type="text" id="pinInput" class="pass-input" placeholder="XXXX" maxlength="4">
            <div id="pinMsg" style="height: 20px; color: red; font-family: 'Orbitron';"></div>
        </div>
        <div style="display: flex;">
            <button class="btn-menu" onclick="checkPin()" style="border-color:#0f0; color:#0f0">VERIFY</button>
            <button class="btn-menu" onclick="closePinMenu()">CANCEL</button>
        </div>
    </div>

    <!-- ACHIEVEMENTS MENU -->
    <div id="achieveMenu" class="overlay hidden">
        <h2 style="color:#ffd700; font-family:'Orbitron';">–î–û–°–¢–ò–ñ–ï–ù–ò–Ø</h2>
        <div class="level-grid" id="ach-list" style="max-height:300px; display:block;"></div>
        <button class="btn-menu" onclick="closeAchievements()">–ù–ê–ó–ê–î</button>
    </div>

    <!-- PASSWORD MENU (CHEATS) -->
    <div id="passwordMenu" class="overlay hidden">
        <h1 style="font-family:'VT323'; color:#0f0;">SECURE LOGIN</h1>
        <input type="text" id="passInput" class="pass-input" placeholder="PASSWORD" style="font-family:'VT323'; border-color:#0f0; color:#0f0;">
        <div style="color:red; height:20px; font-family:'VT323'" id="passError"></div>
        <div style="margin-top:10px;">
            <button class="btn-menu" onclick="checkPassword()" style="border-color:#0f0; color:#0f0">LOGIN</button>
            <button class="btn-menu" onclick="closePasswordMenu()">CANCEL</button>
        </div>
    </div>

    <!-- CHEAT MENU -->
    <div id="cheatMenu" class="overlay hidden">
        <h1>HACKER PANEL</h1>
        <div class="cheat-box">
            <div class="cheat-row"><span>GOD MODE</span><span id="cheat-god" class="cheat-toggle" onclick="toggleCheat('god')">[OFF]</span></div>
            <div class="cheat-row"><span>SPEED HACK</span><span id="cheat-speed" class="cheat-toggle" onclick="toggleCheat('speed')">[OFF]</span></div>
            <div class="cheat-row"><span>SHOW HITBOX</span><span id="cheat-hitbox" class="cheat-toggle" onclick="toggleCheat('hitbox')">[OFF]</span></div>
            <div class="cheat-row"><span>RAINBOW ICON</span><span id="cheat-rainbow" class="cheat-toggle" onclick="toggleCheat('rainbow')">[OFF]</span></div>
            <div class="cheat-row"><span>UNLOCK SKINS</span><span class="cheat-btn" onclick="unlockAll()">[EXECUTE]</span></div>
            <div class="cheat-row"><span>COMPLETE ALL</span><span class="cheat-btn" onclick="completeAllLevels()">[EXECUTE]</span></div>
        </div>
        <button class="btn-menu" onclick="closeCheatMenu()" style="border-color:#0f0; color:#0f0; margin-top:20px;">DISCONNECT</button>
    </div>

    <!-- SETTINGS -->
    <div id="settingsMenu" class="overlay hidden">
        <h1>SETTINGS</h1>
        <div class="garage-container">
            <div style="text-align: center;">–£–ü–†–ê–í–õ–ï–ù–ò–ï</div>
            <button id="ctrl-toggle-btn" onclick="toggleControls()" style="width: 200px;">MODE: PC</button>
        </div>
        <button class="btn-menu" onclick="closeSettings()">–ù–ê–ó–ê–î</button>
    </div>

    <!-- SLOTS MENU -->
    <div id="slotsMenu" class="overlay hidden">
        <h1 id="slots-title">EDITOR SLOTS</h1>
        <div class="garage-container" id="slots-container"></div>
        <button class="btn-menu" onclick="closeSlotsMenu()">–ù–ê–ó–ê–î</button>
    </div>

    <!-- GARAGE -->
    <div id="garageMenu" class="overlay hidden">
        <h1>GARAGE</h1>
        <div class="garage-container">
            <div style="color:#aaa; text-align:center;">–¶–í–ï–¢</div>
            <div class="selection-row" id="color-selector"></div>
            <div style="color:#aaa; text-align:center; margin-top:10px;">–°–ö–ò–ù</div>
            <div class="selection-row" id="skin-selector"></div>
        </div>
        <button class="btn-menu" onclick="closeGarage()">–ì–û–¢–û–í–û</button>
    </div>

    <!-- EDITOR HUD -->
    <div id="editorHUD" class="hidden">
        <div id="editor-ui">
            <div>
                <button onclick="setTool(1)">‚ñ≤</button>
                <button onclick="setTool(2)">‚ñ†</button>
                <button onclick="setTool(3)">üåÄ</button>
                <button onclick="setTool(4)">‚è©</button>
                <button onclick="setTool(6)">üü°</button>
                <button onclick="saveCustomLevel()" style="background:#afa">üíæ</button>
                <button onclick="exitToMenu()" style="background:#faa">‚úñ</button>
            </div>
            <div class="info" id="pc-info">–õ–ö–ú: –°—Ç–∞–≤–∏—Ç—å | –ü–ö–ú: –£–¥–∞–ª–∏—Ç—å | 6: –ú–æ–Ω–µ—Ç–∫–∞</div>
        </div>
        <div id="mob-editor-controls" class="hidden">
            <button onclick="moveCam(-1)">‚Üê</button>
            <button onclick="moveCam(1)">‚Üí</button>
        </div>
    </div>

    <div id="mobile-play-overlay" class="hidden" onmousedown="handleInput(true)" onmouseup="handleInput(false)" ontouchstart="handleInput(true)" ontouchend="handleInput(false)">
        <button id="mob-pause" onmousedown="event.stopPropagation(); exitToMenu();" ontouchstart="event.stopPropagation(); exitToMenu();">MENU</button>
    </div>

    <!-- END SCREEN -->
    <div id="endMenu" class="overlay hidden">
        <h1 id="death-msg">CRASHED</h1>
        <div style="display:flex;">
            <button class="btn-menu" onclick="restartLevel()">–ü–û–í–¢–û–†–ò–¢–¨</button>
            <button class="btn-menu" onclick="exitToMenu()">–ú–ï–ù–Æ</button>
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const bgMusic = document.getElementById('bgMusic');

    // UI Refs
    const mainMenu = document.getElementById('mainMenu');
    const garageMenu = document.getElementById('garageMenu');
    const achieveMenu = document.getElementById('achieveMenu');
    const settingsMenu = document.getElementById('settingsMenu');
    const slotsMenu = document.getElementById('slotsMenu');
    const endMenu = document.getElementById('endMenu');
    const editorHUD = document.getElementById('editorHUD');
    const levelList = document.getElementById('level-list');
    const deathMsg = document.getElementById('death-msg');
    const cheatMenu = document.getElementById('cheatMenu');
    const passwordMenu = document.getElementById('passwordMenu');
    
    // ACCOUNT REFS
    const accountMenu = document.getElementById('accountMenu');
    const pinMenu = document.getElementById('pinMenu');
    const accName = document.getElementById('accName');
    const accPass = document.getElementById('accPass');
    const accMsg = document.getElementById('accMsg');
    const pinInput = document.getElementById('pinInput');
    const pinMsg = document.getElementById('pinMsg');
    const btnAuth = document.getElementById('btn-auth');

    const starCountEl = document.getElementById('star-count');
    const coinCountEl = document.getElementById('coin-count');
    const mobPlayOverlay = document.getElementById('mobile-play-overlay');
    const pcInfo = document.getElementById('pc-info');
    const ctrlToggleBtn = document.getElementById('ctrl-toggle-btn');

    // --- GAME DATA & SAVE SYSTEM ---
    const COLORS = [
        '#00e676', '#ffeb3b', '#2979ff', '#ff1744', '#d500f9', '#00e5ff', 
        '#ffffff', '#ff9900', '#8800ff', '#ff0088', '#00ffaa', '#aaaaaa'
    ];
    const SKINS = [
        {id:0, name:"Box", unlock:"Free"},
        {id:1, name:"Creeper", unlock:"Collect 3 Coins"},
        {id:2, name:"Pro", unlock:"Get 5 Stars"},
        {id:3, name:"Smile", unlock:"Beat Level 1"}
    ];

    let userSettings = { 
        color: COLORS[0], 
        skin: 0, 
        controls: 'PC',
        stars: 0,
        coins: 0,
        unlockedSkins: [0], 
        completedLevels: [],
        isLoggedIn: false 
    };

    // ACHIEVEMENTS
    const ACHIEVEMENTS = [
        {id: "first_win", name: "First Steps", desc: "Pass Level 1", condition: () => userSettings.completedLevels.includes(0), reward: "Skin: Smile", rewardType: "skin", rewardId: 3},
        {id: "rich", name: "Treasure Hunter", desc: "Collect 3 Coins", condition: () => userSettings.coins >= 3, reward: "Skin: Creeper", rewardType: "skin", rewardId: 1},
        {id: "star_master", name: "Star Master", desc: "Collect 5 Stars", condition: () => userSettings.stars >= 5, reward: "Skin: Pro", rewardType: "skin", rewardId: 2}
    ];

    function loadUserData() {
        const saved = localStorage.getItem('drevd_user_v2');
        if(saved) userSettings = Object.assign(userSettings, JSON.parse(saved));
        updateStatsUI();
        updateControlsUI();
        updateAuthButton();
    }
    function saveUserData() { localStorage.setItem('drevd_user_v2', JSON.stringify(userSettings)); updateStatsUI(); }
    function updateStatsUI() {
        starCountEl.innerText = userSettings.stars;
        coinCountEl.innerText = userSettings.coins;
    }
    function toggleControls() { userSettings.controls = (userSettings.controls === 'PC') ? 'MOBILE' : 'PC'; saveUserData(); updateControlsUI(); }
    function updateControlsUI() {
        ctrlToggleBtn.innerText = `MODE: ${userSettings.controls}`;
        pcInfo.style.display = (userSettings.controls === 'MOBILE') ? 'none' : 'block';
    }

    // --- ACCOUNT SYSTEM ---
    function handleAuth() {
        if(userSettings.isLoggedIn) {
            logoutAccount();
        } else {
            openAccountMenu();
        }
    }

    function openAccountMenu() {
        mainMenu.classList.add('hidden');
        accountMenu.classList.remove('hidden');
        accName.value = ''; accPass.value = ''; accMsg.innerText = '';
    }
    function closeAccountMenu() {
        accountMenu.classList.add('hidden');
        mainMenu.classList.remove('hidden');
    }
    
    function loginAccount() {
        if(accName.value === 'Andrevd' && accPass.value === 'AndrevdSecret') {
            // Temp account
            userSettings.stars = 99999999;
            userSettings.coins = 99999999;
            userSettings.isLoggedIn = true; // Set logged in
            updateStatsUI();
            updateAuthButton();
            alert("WELCOME CREATOR (Session Only)");
            closeAccountMenu();
        } 
        else if (accName.value === 'AndrevdAndArtzz' && accPass.value === 'AndrevdAndArtzzTop') {
            // Secret account logic
            accountMenu.classList.add('hidden');
            pinMenu.classList.remove('hidden');
            pinInput.value = '';
            pinMsg.innerText = '';
        }
        else {
            accMsg.innerText = "INVALID CREDENTIALS";
        }
    }

    function checkPin() {
        if(pinInput.value === '2526') {
            userSettings.stars = "9999999999999999"; 
            userSettings.coins = "9999999999999999";
            userSettings.isLoggedIn = true;
            userSettings.unlockedSkins = [0,1,2,3]; 
            saveUserData();
            updateAuthButton();
            
            closePinMenu();
            alert("GOD ACCOUNT ACTIVATED. PROGRESS SAVED.");
        } else {
            pinMsg.innerText = "WRONG PIN";
        }
    }

    function closePinMenu() {
        pinMenu.classList.add('hidden');
        mainMenu.classList.remove('hidden');
    }

    function logoutAccount() {
        if(confirm("LOG OUT and RESET progress?")) {
            localStorage.removeItem('drevd_user_v2'); // –ü–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π
            location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        }
    }

    function updateAuthButton() {
        if(userSettings.isLoggedIn) {
            btnAuth.innerText = "üë§ LOG OUT";
            btnAuth.style.borderColor = "red";
            btnAuth.style.color = "red";
        } else {
            btnAuth.innerText = "üë§ LOG IN";
            btnAuth.style.borderColor = "#00e5ff";
            btnAuth.style.color = "#00e5ff";
        }
    }

    // --- CHEATS ---
    let cheats = { god: false, speed: false, hitbox: false, rainbow: false };
    function openPasswordMenu() { mainMenu.classList.add('hidden'); passwordMenu.classList.remove('hidden'); document.getElementById('passInput').value=''; }
    function closePasswordMenu() { passwordMenu.classList.add('hidden'); mainMenu.classList.remove('hidden'); }
    function checkPassword() {
        if(document.getElementById('passInput').value === "Andrevdtop") { passwordMenu.classList.add('hidden'); cheatMenu.classList.remove('hidden'); }
        else { document.getElementById('passError').innerText="WRONG PASSWORD"; }
    }
    function toggleCheat(c) {
        cheats[c] = !cheats[c];
        const el = document.getElementById(`cheat-${c}`);
        el.innerText = cheats[c] ? "[ON]" : "[OFF]";
        el.classList.toggle('on', cheats[c]);
    }
    function unlockAll() { userSettings.unlockedSkins = [0,1,2,3]; saveUserData(); alert("ALL SKINS UNLOCKED!"); }
    function completeAllLevels() {
        LEVELS.forEach((lvl, i) => {
            if(!userSettings.completedLevels.includes(i)) {
                userSettings.completedLevels.push(i);
                userSettings.stars += lvl.stars;
            }
        });
        saveUserData(); initMenu(); alert("ALL LEVELS COMPLETED & STARS ADDED!");
    }
    function closeCheatMenu() { cheatMenu.classList.add('hidden'); mainMenu.classList.remove('hidden'); }

    // --- ACHIEVEMENTS LOGIC ---
    function checkAchievements() {
        let changed = false;
        ACHIEVEMENTS.forEach(ach => {
            if(ach.condition() && !userSettings.unlockedSkins.includes(ach.rewardId) && ach.rewardType === 'skin') {
                userSettings.unlockedSkins.push(ach.rewardId);
                alert(`ACHIEVEMENT UNLOCKED: ${ach.name}\nReward: ${ach.reward}`);
                changed = true;
            }
        });
        if(changed) saveUserData();
    }

    function openAchievements() {
        mainMenu.classList.add('hidden'); achieveMenu.classList.remove('hidden');
        const list = document.getElementById('ach-list'); list.innerHTML = '';
        ACHIEVEMENTS.forEach(ach => {
            let unlocked = false;
            if(ach.rewardType === 'skin' && userSettings.unlockedSkins.includes(ach.rewardId)) unlocked = true;
            let item = document.createElement('div');
            item.style.padding = "10px"; item.style.border = "1px solid #444"; item.style.marginBottom = "5px"; item.style.background="#222";
            if(unlocked) { item.style.borderColor = "#0f0"; item.style.background = "#1a331a"; }
            item.innerHTML = `<div style="font-weight:bold; color:white;">${ach.name} ${unlocked ? '‚úÖ' : 'üîí'}</div><div style="font-size:12px; color:#aaa;">${ach.desc}</div><div style="font-size:10px; color:${unlocked?'#0f0':'#777'}">${ach.reward}</div>`;
            list.appendChild(item);
        });
    }
    function closeAchievements() { achieveMenu.classList.add('hidden'); mainMenu.classList.remove('hidden'); }

    // --- GAME VARS ---
    const BLOCK_SIZE = 40;
    const GRAVITY = 0.65;
    const JUMP_FORCE = -10.8;
    const SHIP_GRAVITY = 0.35;
    const SHIP_LIFT = -0.45;

    let animationId = null;
    let gameState = 'MENU';
    let currentLevelData = [];
    let currentLevelIndex = -1; 
    let currentSlotId = 0;
    let cameraX = 0;
    let currentSpeed = 6.0;
    let particles = [];
    let isHolding = false;
    let editorScrollX = 0;
    let selectedTool = 1;
    let sessionCoins = 0;

    let player = {
        x: 0, y: 0, dy: 0, angle: 0, width: 30, height: 30,
        mode: 'CUBE', onGround: false, isDead: false,
        color: '#00e676', skinId: 0, endX: 0
    };

    // --- MUSIC ---
    const MUSIC_TRACKS = {
        techno: "gspd.mp3",
        fast: "https://commondatastorage.googleapis.com/codeskulptor-demos/riceracer_assets/music/race1.ogg",
        epic: "https://commondatastorage.googleapis.com/codeskulptor-assets/week7-brrring.m4a",
        demon: "https://commondatastorage.googleapis.com/codeskulptor-demos/pyman_assets/eaten.ogg"
    };

    // --- LEVELS ---
    const LEVELS = [
        { 
            name: "Genesis", diff: "Easy", stars: 3, track: "techno",
            data: [{x:5,y:0,t:2},{x:6,y:0,t:2},{x:7,y:0,t:2},{x:10,y:2,t:6},{x:12,y:0,t:1},{x:16,y:0,t:2},{x:17,y:1,t:2},{x:22,y:0,t:1},{x:26,y:0,t:4},{x:32,y:0,t:2},{x:32,y:1,t:2},{x:38,y:0,t:1},{x:45,y:0,t:5},{x:50,y:0,t:2},{x:50,y:1,t:1},{x:55,y:0,t:1},{x:56,y:0,t:1}] 
        },
        { 
            name: "Coin Rush", diff: "Normal", stars: 5, track: "epic",
            data: [{x:5,y:0,t:2},{x:8,y:0,t:3},{x:10,y:3,t:6},{x:15,y:4,t:2},{x:18,y:1,t:6},{x:20,y:2,t:2},{x:25,y:5,t:2},{x:30,y:1,t:2},{x:32,y:3,t:6},{x:35,y:4,t:2},{x:40,y:0,t:3},{x:45,y:0,t:1},{x:48,y:0,t:1},{x:52,y:0,t:2},{x:52,y:1,t:1}] 
        },
        { 
            name: "Speed Run", diff: "Hard", stars: 8, track: "fast",
            data: [{x:3,y:0,t:4},{x:8,y:0,t:1},{x:14,y:0,t:2},{x:18,y:0,t:1},{x:24,y:1,t:2},{x:30,y:0,t:3},{x:35,y:5,t:2},{x:40,y:0,t:2},{x:45,y:5,t:2},{x:50,y:0,t:3},{x:55,y:0,t:5},{x:60,y:0,t:1},{x:61,y:0,t:1},{x:62,y:0,t:1}] 
        },
        {
            name: "Demon Hell", diff: "Insane", stars: 14, track: "demon",
            data: [
                {x:5,y:0,t:4}, 
                {x:8,y:0,t:1},{x:9,y:0,t:1},{x:10,y:0,t:1}, 
                {x:12,y:2,t:6}, 
                {x:15,y:0,t:2},{x:15,y:1,t:1}, 
                {x:20,y:0,t:3}, 
                {x:25,y:1,t:2},{x:25,y:4,t:2}, 
                {x:30,y:0,t:2},{x:30,y:5,t:2}, {x:32,y:3,t:6}, 
                {x:38,y:0,t:3}, 
                {x:42,y:0,t:1},{x:43,y:0,t:1},{x:44,y:0,t:1}, 
                {x:50,y:0,t:2},{x:50,y:1,t:2},{x:50,y:2,t:6}, 
                {x:55,y:0,t:1},{x:56,y:0,t:1}
            ]
        }
    ];

    // --- SFX ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function sfx(type) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;
        if(type === 'jump') { osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(300, now + 0.1); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.1); osc.start(now); osc.stop(now + 0.1); }
        else if (type === 'coin') { osc.type='sine'; osc.frequency.setValueAtTime(600, now); osc.frequency.linearRampToValueAtTime(1200, now + 0.1); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.1); osc.start(now); osc.stop(now + 0.1); }
        else if (type === 'crash') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(100, now); osc.frequency.exponentialRampToValueAtTime(10, now + 0.4); gain.gain.setValueAtTime(0.3, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.4); osc.start(now); osc.stop(now + 0.4); }
    }

    // --- INIT ---
    function init() { loadUserData(); initMenu(); ctx.fillStyle='#000'; ctx.fillRect(0,0,800,450); }

    function initMenu() {
        levelList.innerHTML = '';
        LEVELS.forEach((lvl, index) => {
            let btn = document.createElement('div'); btn.className = 'level-card';
            let starsEarned = userSettings.completedLevels.includes(index) ? `‚≠ê${lvl.stars}` : '';
            btn.innerHTML = `<div class="lvl-header"><span>${lvl.name}</span><span class="diff-${lvl.diff}">${lvl.diff}</span></div>
                             <div class="lvl-sub"><span>${starsEarned}</span><span>Stars: ${lvl.stars}</span></div>`;
            btn.onclick = () => startLevel(index);
            levelList.appendChild(btn);
        });
        let custom = document.createElement('div'); custom.className = 'level-card';
        custom.innerHTML = `<div class="lvl-header"><span style="color:#0ff">My Levels</span><span>USER</span></div>`;
        custom.onclick = () => openSlotsMenu(true); 
        levelList.appendChild(custom);
        initGarage();
    }

    function initGarage() {
        const cc = document.getElementById('color-selector'); const sc = document.getElementById('skin-selector');
        cc.innerHTML = ''; sc.innerHTML = '';
        COLORS.forEach(c => {
            let b = document.createElement('div'); b.className = 'color-btn'; b.style.background = c;
            if(c === userSettings.color) b.classList.add('active');
            b.onclick = () => { userSettings.color = c; saveUserData(); initGarage(); };
            cc.appendChild(b);
        });
        SKINS.forEach(s => {
            let b = document.createElement('div'); 
            let unlocked = userSettings.unlockedSkins.includes(s.id);
            b.className = `skin-btn ${unlocked ? '' : 'locked'}`;
            if(s.id === userSettings.skin) b.classList.add('active');
            let cvs = document.createElement('canvas'); cvs.width=40; cvs.height=40;
            if(unlocked) drawAvatar(cvs.getContext('2d'), 20, 20, 30, s.id, userSettings.color, 0, 'CUBE');
            b.appendChild(cvs);
            b.onclick = () => { if(unlocked) { userSettings.skin = s.id; saveUserData(); initGarage(); } else alert(`LOCKED! ${s.unlock}`); };
            sc.appendChild(b);
        });
    }

    // --- MENUS ---
    function openSettings() { mainMenu.classList.add('hidden'); settingsMenu.classList.remove('hidden'); }
    function closeSettings() { settingsMenu.classList.add('hidden'); mainMenu.classList.remove('hidden'); }
    function openGarage() { mainMenu.classList.add('hidden'); garageMenu.classList.remove('hidden'); }
    function closeGarage() { garageMenu.classList.add('hidden'); mainMenu.classList.remove('hidden'); }
    function openSlotsMenu(isPlayMode = false) {
        mainMenu.classList.add('hidden'); slotsMenu.classList.remove('hidden');
        document.getElementById('slots-title').innerText = isPlayMode ? "PLAY SLOT" : "EDIT SLOT";
        const cont = document.getElementById('slots-container'); cont.innerHTML = '';
        for(let i=0; i<3; i++) {
            let key = `drevd_custom_${i}`; let data = localStorage.getItem(key); let exists = data && JSON.parse(data).length > 0;
            let btn = document.createElement('button'); btn.className = 'btn-slot';
            btn.innerHTML = `<span>SLOT ${i+1}</span> ${exists ? '<span style="color:#0f0">DATA</span>' : '<span style="color:#555">EMPTY</span>'}`;
            btn.onclick = () => { currentSlotId = i; if(isPlayMode && !exists) { if(confirm("Empty slot. Edit?")) openEditor(i); } else if(isPlayMode) startLevel('custom'); else openEditor(i); };
            cont.appendChild(btn);
        }
    }
    function closeSlotsMenu() { slotsMenu.classList.add('hidden'); mainMenu.classList.remove('hidden'); }

    // --- GAME ---
    function startLevel(idx) {
        if(animationId) cancelAnimationFrame(animationId);
        let trackKey = "track1";
        if (idx === 'custom') {
            const saved = localStorage.getItem(`drevd_custom_${currentSlotId}`);
            currentLevelData = saved ? JSON.parse(saved) : [];
        } else {
            currentLevelData = JSON.parse(JSON.stringify(LEVELS[idx].data));
            trackKey = LEVELS[idx].track;
        }
        currentLevelIndex = idx;
        let maxX = 0; currentLevelData.forEach(o => { if(o.x > maxX) maxX = o.x; });
        player.endX = (maxX * BLOCK_SIZE) + 600;
        currentLevelData.forEach(o => o.collected = false); sessionCoins = 0;

        mainMenu.classList.add('hidden'); endMenu.classList.add('hidden'); editorHUD.classList.add('hidden'); slotsMenu.classList.add('hidden'); cheatMenu.classList.add('hidden'); passwordMenu.classList.add('hidden'); achieveMenu.classList.add('hidden'); accountMenu.classList.add('hidden'); pinMenu.classList.add('hidden');
        if(userSettings.controls === 'MOBILE') mobPlayOverlay.classList.remove('hidden'); else mobPlayOverlay.classList.add('hidden');

        player.color = userSettings.color; player.skinId = userSettings.skin;
        resetPlayer(); particles = []; gameState = 'PLAY';
        
        bgMusic.src = MUSIC_TRACKS[trackKey] || MUSIC_TRACKS.techno;
        bgMusic.volume = 0.4; bgMusic.currentTime = 0; bgMusic.play().catch(e => {});
        loop();
    }

    function resetPlayer() {
        player.x = 100; player.y = canvas.height - 50 - player.height;
        player.dy = 0; player.angle = 0; player.mode = 'CUBE';
        player.isDead = false; player.onGround = true;
        cameraX = 0; isHolding = false; currentSpeed = cheats.speed ? 10.0 : 6.0;
    }

    function restartLevel() { startLevel(currentLevelIndex); }
    function exitToMenu() {
        if(animationId) cancelAnimationFrame(animationId);
        gameState = 'MENU';
        mainMenu.classList.remove('hidden'); endMenu.classList.add('hidden'); editorHUD.classList.add('hidden'); 
        mobPlayOverlay.classList.add('hidden'); document.getElementById('mob-editor-controls').classList.add('hidden');
        bgMusic.pause(); ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
        initMenu();
    }

    function loop() {
        if(gameState === 'PLAY') { update(); draw(); animationId = requestAnimationFrame(loop); }
        else if (gameState === 'EXPLODING') { drawExplosion(); animationId = requestAnimationFrame(loop); }
        else if (gameState === 'EDITOR') { drawEditor(); animationId = requestAnimationFrame(loop); }
    }

    function update() {
        if (player.mode === 'CUBE') {
            player.dy += GRAVITY * (cheats.gravity ? -1 : 1);
            if(isHolding && player.onGround) { player.dy = JUMP_FORCE * (cheats.gravity ? -1 : 1); player.onGround = false; sfx('jump'); }
            if(!player.onGround) player.angle += 0.15; else player.angle = Math.round(player.angle/(Math.PI/2))*(Math.PI/2);
        } else {
            let lift = isHolding ? SHIP_LIFT : SHIP_GRAVITY;
            if(cheats.gravity) lift = isHolding ? -SHIP_LIFT : -SHIP_GRAVITY;
            player.dy += lift;
            player.angle = player.dy * 0.1;
        }
        
        player.y += player.dy; player.x += (cheats.speed ? 12.0 : currentSpeed); cameraX = player.x - 200;

        if(Math.random()>0.5) particles.push(new Particle(player.x, player.y+15, player.color, 'trail'));
        const groundY = canvas.height - 50;
        
        if(!cheats.gravity) {
            if(player.y + player.height > groundY) { player.y = groundY - player.height; player.dy = 0; player.onGround = true; } else player.onGround = false;
        } else {
            if(player.y < 0) { player.y = 0; player.dy = 0; player.onGround = true; } else player.onGround = false;
        }

        if(player.x > player.endX) { winLevel(); return; }
        checkCollisions(groundY);
    }

    function checkCollisions(groundY) {
        let pRect = {l: player.x+8, r: player.x+player.width-8, t: player.y+8, b: player.y+player.height-8};
        for(let obj of currentLevelData) {
            let ox = obj.x * BLOCK_SIZE; let oy = groundY - (obj.y * BLOCK_SIZE) - BLOCK_SIZE;
            if(ox < cameraX - 100 || ox > cameraX + 900) continue;
            if(obj.t === 6 && !obj.collected) { if(rectIntersect(player.x, player.x+30, player.y, player.y+30, ox, ox+40, oy, oy+40)) { obj.collected = true; sessionCoins++; sfx('coin'); } continue; }
            if(cheats.god) continue;
            if(obj.t === 1) { if(rectIntersect(pRect.l, pRect.r, pRect.t, pRect.b, ox+10, ox+30, oy+10, oy+40)) crash(); }
            else if (obj.t === 2) {
                if(rectIntersect(player.x+2, player.x+28, player.y+2, player.y+28, ox, ox+40, oy, oy+40)) {
                    if(!cheats.gravity) {
                        if(player.dy > 0 && pRect.b <= oy+20) { player.y = oy - player.height; player.dy = 0; player.onGround = true; player.angle = Math.round(player.angle/(Math.PI/2))*(Math.PI/2); }
                        else if (player.mode === 'SHIP' && player.dy < 0 && pRect.t >= oy+20) { player.y = oy + 40; player.dy = 0; }
                        else if (player.mode === 'SHIP' && player.dy > 0 && pRect.b <= oy+20) { player.y = oy - player.height; player.dy = 0; }
                        else crash();
                    } else { crash(); }
                }
            } 
            else if (obj.t === 3 && rectIntersect(player.x, player.x+30, player.y, player.y+30, ox, ox+40, oy, oy+40)) player.mode = player.mode === 'CUBE' ? 'SHIP' : 'CUBE';
            else if (obj.t === 4 && rectIntersect(player.x, player.x+30, player.y, player.y+30, ox, ox+40, oy, oy+40)) currentSpeed = 8.5;
            else if (obj.t === 5 && rectIntersect(player.x, player.x+30, player.y, player.y+30, ox, ox+40, oy, oy+40)) currentSpeed = 6.0;
        }
    }
    function rectIntersect(l1, r1, t1, b1, l2, r2, t2, b2) { return !(l2 > r1 || r2 < l1 || t2 > b1 || b2 < t1); }
    function crash() { if(player.isDead) return; player.isDead = true; gameState = 'EXPLODING'; sfx('crash'); bgMusic.pause(); for(let i=0; i<30; i++) particles.push(new Particle(player.x+15, player.y+15, player.color, 'explode')); setTimeout(() => { deathMsg.innerText = "CRASHED"; deathMsg.style.color = "#ff3333"; endMenu.classList.remove('hidden'); }, 1000); }
    function winLevel() { 
        gameState = 'GAMEOVER'; bgMusic.pause(); 
        if(currentLevelIndex !== -1 && !userSettings.completedLevels.includes(currentLevelIndex)) {
            userSettings.completedLevels.push(currentLevelIndex);
            userSettings.stars = Number(userSettings.stars) + LEVELS[currentLevelIndex].stars;
        }
        userSettings.coins = Number(userSettings.coins) + sessionCoins;
        saveUserData(); checkAchievements();
        deathMsg.innerText = `COMPLETE!\n+${sessionCoins} Coins`; deathMsg.style.color = "#0f0"; endMenu.classList.remove('hidden'); 
    }

    function draw() {
        ctx.clearRect(0,0, canvas.width, canvas.height); drawBackground();
        ctx.save(); ctx.translate(-cameraX, 0); drawLevel(canvas.height-50);
        for(let i=particles.length-1; i>=0; i--) { particles[i].update(); particles[i].draw(ctx); if(particles[i].life<=0) particles.splice(i,1); }
        drawAvatar(ctx, player.x+15, player.y+15, 30, player.skinId, player.color, player.angle, player.mode);
        if(cheats.hitbox) { ctx.strokeStyle='#0f0'; ctx.strokeRect(player.x, player.y, 30, 30); }
        ctx.restore();
    }
    function drawExplosion() { ctx.clearRect(0,0, canvas.width, canvas.height); drawBackground(); ctx.save(); ctx.translate(-cameraX, 0); drawLevel(canvas.height-50); for(let i=particles.length-1; i>=0; i--) { particles[i].update(); particles[i].draw(ctx); if(particles[i].life<=0) particles.splice(i,1); } ctx.restore(); }
    function drawBackground() { let grad = ctx.createLinearGradient(0,0,0,canvas.height); grad.addColorStop(0, player.mode==='CUBE'?'#1a1a2e':'#2c0000'); grad.addColorStop(1, player.mode==='CUBE'?'#16213e':'#4a0000'); ctx.fillStyle = grad; ctx.fillRect(0,0,canvas.width,canvas.height); }
    function drawLevel(groundY) {
        ctx.fillStyle = '#000'; ctx.fillRect(cameraX, groundY, canvas.width, 50); ctx.fillStyle = '#fff'; ctx.fillRect(cameraX, groundY, canvas.width, 2);
        for(let obj of currentLevelData) {
            let ox = obj.x * BLOCK_SIZE; let oy = groundY - (obj.y * BLOCK_SIZE) - BLOCK_SIZE;
            if(ox < cameraX - 100 || ox > cameraX + 900) continue;
            if(cheats.hitbox) { ctx.strokeStyle = obj.t===1?'red':'green'; ctx.strokeRect(ox, oy, 40, 40); }
            if(obj.t === 1) { ctx.fillStyle = '#111'; ctx.beginPath(); ctx.moveTo(ox, oy+40); ctx.lineTo(ox+20, oy); ctx.lineTo(ox+40, oy+40); ctx.fill(); ctx.strokeStyle = '#f00'; ctx.shadowBlur=10; ctx.shadowColor='#f00'; ctx.stroke(); ctx.shadowBlur=0; }
            else if (obj.t === 2) { ctx.fillStyle = '#000'; ctx.fillRect(ox, oy, 40, 40); ctx.strokeStyle = '#0ff'; ctx.shadowBlur=10; ctx.shadowColor='#0ff'; ctx.strokeRect(ox, oy, 40, 40); ctx.shadowBlur=0; }
            else if (obj.t === 3) { ctx.strokeStyle = '#0f0'; ctx.beginPath(); ctx.arc(ox+20,oy+20,20,0,7); ctx.stroke(); }
            else if (obj.t === 4) { ctx.fillStyle='orange'; ctx.fillText('>>', ox+10, oy+25); }
            else if (obj.t === 5) { ctx.fillStyle='cyan'; ctx.fillText('>', ox+15, oy+25); }
            else if (obj.t === 6 && !obj.collected) { ctx.fillStyle='#ffd700'; ctx.beginPath(); ctx.arc(ox+20,oy+20, 15, 0, 7); ctx.fill(); ctx.strokeStyle='#fff'; ctx.lineWidth=2; ctx.stroke(); ctx.fillStyle='#b8860b'; ctx.fillText('$', ox+15, oy+25); }
        }
    }
    function drawAvatar(ctx, x, y, size, skinId, color, angle, mode) {
        ctx.save(); ctx.translate(x, y); ctx.rotate(angle);
        
        let drawColor = color;
        if(cheats.rainbow) {
            let hue = (Date.now() / 5) % 360;
            drawColor = `hsl(${hue}, 100%, 50%)`;
        }

        ctx.shadowBlur = 15; ctx.shadowColor = drawColor; ctx.fillStyle = drawColor; let s = size;
        if (mode === 'SHIP') { ctx.beginPath(); ctx.moveTo(s/2, 0); ctx.lineTo(-s/3, s/3); ctx.lineTo(-s/3, -s/3); ctx.fill(); ctx.fillStyle = 'rgba(0,0,0,0.4)'; ctx.beginPath(); ctx.moveTo(s/6,0); ctx.lineTo(-s/6, s/6); ctx.lineTo(-s/6, -s/6); ctx.fill(); }
        else {
            ctx.fillRect(-s/2, -s/2, s, s); ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.strokeRect(-s/2, -s/2, s, s); ctx.fillStyle = '#000';
            if (skinId === 1) { ctx.fillRect(-5,-5,10,10); ctx.fillRect(-10,-10,5,5); ctx.fillRect(5,-10,5,5); } 
            else if (skinId === 2) ctx.fillRect(-15,-5,30,10);
            else if (skinId === 3) { ctx.beginPath(); ctx.arc(-7,-7,3,0,7); ctx.fill(); ctx.beginPath(); ctx.arc(7,-7,3,0,7); ctx.fill(); ctx.beginPath(); ctx.arc(0,5,7,0,3.14); ctx.stroke(); }
        }
        ctx.restore();
    }
    class Particle {
        constructor(x, y, color, type) { this.x=x; this.y=y; this.type=type; this.color=color; this.life=1.0; this.vx=(Math.random()-0.5)*(type==='explode'?10:2); this.vy=(Math.random()-0.5)*(type==='explode'?10:2); this.size=Math.random()*(type==='explode'?6:4)+2; }
        update() { this.x+=this.vx; this.y+=this.vy; this.life-=(this.type==='explode'?0.02:0.05); if(this.type==='trail') this.size*=0.9; }
        draw(ctx) { ctx.globalAlpha=Math.max(0, this.life); ctx.fillStyle=cheats.rainbow ? `hsl(${Math.random()*360},100%,50%)` : this.color; ctx.fillRect(this.x,this.y,this.size,this.size); ctx.globalAlpha=1.0; }
    }

    function handleInput(down) { if(gameState === 'PLAY') isHolding = down; }
    window.addEventListener('keydown', e => { if(e.code==='Space'||e.code==='ArrowUp') handleInput(true); });
    window.addEventListener('keyup', e => { if(e.code==='Space'||e.code==='ArrowUp') handleInput(false); });
    canvas.addEventListener('mousedown', e => { if(gameState==='PLAY') handleInput(true); else if(gameState==='EDITOR') handleEditorClick(e); });
    canvas.addEventListener('mouseup', () => handleInput(false));
    canvas.addEventListener('contextmenu', e => { e.preventDefault(); if(gameState==='EDITOR') handleEditorClick(e, true); });

    function openEditor(slotId) { if(animationId) cancelAnimationFrame(animationId); gameState = 'EDITOR'; currentSlotId = slotId; const key = `drevd_custom_${slotId}`; currentLevelData = localStorage.getItem(key) ? JSON.parse(localStorage.getItem(key)) : []; editorScrollX=0; slotsMenu.classList.add('hidden'); editorHUD.classList.remove('hidden'); if(userSettings.controls === 'MOBILE') document.getElementById('mob-editor-controls').classList.remove('hidden'); bgMusic.pause(); loop(); }
    function drawEditor() { ctx.clearRect(0,0, canvas.width, canvas.height); let groundY = canvas.height-50; ctx.fillStyle='#222'; ctx.fillRect(0,0,800,450); let offset = editorScrollX%BLOCK_SIZE; ctx.strokeStyle='#444'; ctx.beginPath(); for(let i=0;i<21;i++) { ctx.moveTo(i*40-offset,0); ctx.lineTo(i*40-offset,groundY); } ctx.stroke(); ctx.fillStyle='#000'; ctx.fillRect(0,groundY,800,50); for(let obj of currentLevelData) { let px = obj.x*BLOCK_SIZE-editorScrollX; let py=groundY-obj.y*BLOCK_SIZE-BLOCK_SIZE; if(px>-40 && px<800) { if(obj.t===1) { ctx.fillStyle='rgba(255,0,0,0.5)'; ctx.beginPath(); ctx.moveTo(px,py+40); ctx.lineTo(px+20,py); ctx.lineTo(px+40,py+40); ctx.fill(); } else if(obj.t===6) { ctx.fillStyle='yellow'; ctx.beginPath(); ctx.arc(px+20,py+20,15,0,7); ctx.fill(); } else ctx.fillStyle='rgba(0,255,255,0.5)'; ctx.fillRect(px,py,40,40); } } }
    function handleEditorClick(e, isRight) { let r = canvas.getBoundingClientRect(); let mx=e.clientX-r.left+editorScrollX, my=e.clientY-r.top; let gx=Math.floor(mx/40), gy=Math.floor((400-my)/40); if(gy<0||gy>9) return; currentLevelData = currentLevelData.filter(o=>!(o.x===gx&&o.y===gy)); if(!isRight) currentLevelData.push({x:gx,y:gy,t:selectedTool}); }
    function setTool(t) { selectedTool = t; }
    function moveCam(dir) { editorScrollX += dir * 40; if(editorScrollX<0) editorScrollX=0; }
    function saveCustomLevel() { localStorage.setItem(`drevd_custom_${currentSlotId}`, JSON.stringify(currentLevelData)); alert(`–°–ª–æ—Ç ${currentSlotId+1} –°–æ—Ö—Ä–∞–Ω–µ–Ω!`); }
    window.addEventListener('keydown', e => { if(gameState==='EDITOR') { if(e.code==='ArrowRight') editorScrollX+=20; if(e.code==='ArrowLeft') editorScrollX=Math.max(0,editorScrollX-20); if(e.key>='1' && e.key<='6') selectedTool = parseInt(e.key); } });

    init();
</script>
</body>
</html>
