<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GEOMETRY DREVD: OPTIMIZED</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@900&family=VT323&display=swap');

        body {
            margin: 0;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            color: white;
            font-family: 'Roboto', sans-serif;
            overflow: hidden;
            user-select: none;
            touch-action: none;
        }

        #game-wrapper {
            position: relative;
            aspect-ratio: 16/9;
            width: 100%;
            max-height: 100vh;
            max-width: 177.78vh;
            background: #000;
            box-shadow: 0 0 50px rgba(0, 255, 0, 0.2);
            border: 2px solid #333;
        }

        canvas { 
            display: block; 
            width: 100%; 
            height: 100%;
            image-rendering: pixelated;
        }

        /* UI */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(0, 0, 0, 0.92); z-index: 20;
            backdrop-filter: blur(4px); transition: opacity 0.2s;
        }
        .hidden { display: none !important; opacity: 0; pointer-events: none; }

        h1 {
            font-family: 'Orbitron', sans-serif; font-size: 8cqh; margin-bottom: 20px; color: #fff;
            text-shadow: 0 0 10px #00ff00, 0 0 30px #005500; text-align: center;
        }

        .stats-bar { display: flex; gap: 20px; font-family: 'Orbitron'; font-size: 24px; color: #ffd700; margin-bottom: 20px; text-shadow: 0 0 5px #ffd700; }
        #death-msg { color: #ff3333; text-shadow: 0 0 20px #ff0000; font-size: 60px; margin-bottom: 20px; }

        button {
            border: 1px solid #555; padding: 10px 20px; font-size: 16px; font-weight: bold; color: #eee;
            cursor: pointer; border-radius: 5px; text-transform: uppercase; margin: 5px; transition: 0.1s;
            font-family: 'Orbitron', sans-serif; background: #222;
        }
        button:active { transform: scale(0.95); }
        .btn-garage { background: linear-gradient(45deg, #11998e, #38ef7d); border:none; color:#fff; }
        .btn-achieve { background: linear-gradient(45deg, #ff9966, #ff5e62); border:none; color:#fff; }
        .btn-slot { width: 250px; text-align: left; display: flex; justify-content: space-between; align-items: center; }

        .btn-secret { position: absolute; bottom: 15px; right: 15px; background: transparent; border: 1px solid #444; color: #555; font-size: 24px; padding: 5px 12px; z-index: 100; }
        .btn-secret:hover { color: red; border-color: red; }
        
        #btn-auth { 
            position: absolute; top: 15px; left: 15px; 
            background: transparent; border: 1px solid #00e5ff; color: #00e5ff; 
            font-size: 14px; padding: 8px 15px; z-index: 100; 
        }

        #btn-fullscreen {
            position: absolute; top: 15px; right: 15px;
            background: transparent; border: 1px solid #fff; color: #fff;
            font-size: 20px; padding: 5px 10px; z-index: 100;
        }

        /* Lists & Grids */
        .level-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 85%; max-width: 600px; max-height: 250px; overflow-y: auto; margin-bottom: 10px; padding-right: 5px; }
        .level-card { background: #1a1a1a; padding: 15px; border: 1px solid #444; cursor: pointer; display: flex; flex-direction: column; border-radius: 6px; }
        .level-card:hover { background: #252525; border-color: #ffd700; }
        .lvl-header { display: flex; justify-content: space-between; font-weight: bold; }
        .lvl-sub { font-size: 12px; color: #888; margin-top: 5px; display: flex; justify-content: space-between; }

        .garage-container { display: flex; flex-direction: column; gap: 10px; background: rgba(20,20,20,0.95); padding: 20px; border-radius: 10px; border: 1px solid #444; }
        .selection-row { display: flex; gap: 10px; justify-content: center; align-items: center; flex-wrap: wrap; }
        .color-btn { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid #444; margin: 2px; }
        .color-btn.active { border-color: #fff; box-shadow: 0 0 10px #fff; }
        .skin-btn { width: 50px; height: 50px; border: 2px solid #444; background: #111; cursor: pointer; position: relative; display: flex; justify-content: center; align-items: center; }
        .skin-btn.active { border-color: #0f0; box-shadow: 0 0 10px #0f0; }
        .skin-btn.locked { opacity: 0.5; cursor: not-allowed; }
        .skin-btn.locked::after { content: 'üîí'; position: absolute; font-size: 20px; }

        .pass-input { background: #111; border: 1px solid #0f0; color: #0f0; font-family: 'VT323'; font-size: 26px; text-align: center; padding: 5px; width: 200px; }

        #editor-ui { position: absolute; top: 10px; left: 10px; right: 10px; display: flex; justify-content: center; flex-wrap:wrap; gap: 5px; pointer-events: none; }
        #editor-ui button { pointer-events: auto; padding: 5px 12px; background: #fff; color: #000; border: none; font-size:18px; border-radius:4px; }
        .info { pointer-events: auto; background: rgba(0,0,0,0.8); padding: 5px; color: #aaa; border-radius: 4px; font-size: 12px; margin-top:5px; width:100%; text-align:center;}
        
        #mobile-play-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; touch-action: none; }
        #mob-pause { position: absolute; top: 15px; right: 15px; width: 50px; height: 50px; border-radius: 5px; font-size: 12px; pointer-events: auto; background: rgba(255,255,255,0.2); border: 2px solid white; color: white;}
        #mob-editor-controls { position: absolute; bottom: 20px; left: 0; width: 100%; display: flex; justify-content: center; gap: 30px; pointer-events: none; }
        #mob-editor-controls button { pointer-events: auto; width: 60px; height: 60px; font-size: 24px; background: rgba(0,0,0,0.5); color: white; border: 2px solid white; border-radius: 50%; }

        /* Cheat Menu */
        #cheatMenu { background: rgba(0, 20, 0, 0.98); font-family: 'VT323', monospace; color: #0f0; }
        .cheat-box { border: 1px solid #0f0; padding: 20px; width: 70%; display: flex; flex-direction: column; gap: 8px; }
        .cheat-row { display: flex; justify-content: space-between; font-size: 22px; border-bottom: 1px solid #004400; }
        .cheat-toggle { cursor: pointer; color: #555; font-weight: bold; }
        .cheat-toggle.on { color: #0f0; text-shadow: 0 0 5px #0f0; }

        .diff-Easy { color: #2ecc71; }
        .diff-Normal { color: #f1c40f; }
        .diff-Hard { color: #e67e22; }
        .diff-Insane { color: #ff0055; text-shadow: 0 0 5px #ff0055; }

    </style>
</head>
<body>

<audio id="bgMusic" loop></audio>

<div id="game-wrapper">
    <!-- IMPORTANT: Fixed resolution for logic, scaled by CSS -->
    <canvas id="gameCanvas" width="800" height="450"></canvas>
    
    <!-- MAIN MENU -->
    <div id="mainMenu" class="overlay">
        <h1>GEOMETRY DREVD 2.1</h1>
        
        <div class="stats-bar">
            <span>‚≠ê <span id="star-count">0</span></span>
            <span>üü° <span id="coin-count">0</span></span>
        </div>

        <div id="level-list" class="level-grid"></div>
        <div style="display:flex; flex-wrap: wrap; justify-content: center;">
            <button class="btn-garage" onclick="openGarage()">üé® –ì–ê–†–ê–ñ</button>
            <button class="btn-achieve" onclick="openAchievements()">üèÜ –î–û–°–¢–ò–ñ–ï–ù–ò–Ø</button>
            <button class="btn-menu" onclick="openSlotsMenu(false)">üõ† –†–ï–î–ê–ö–¢–û–†</button>
            <button class="btn-menu" onclick="openSettings()">‚öô –ù–ê–°–¢–†–û–ô–ö–ò</button>
        </div>
        
        <button id="btn-auth" onclick="handleAuth()">üë§ LOG IN</button>
        <button id="btn-fullscreen" onclick="toggleFullScreen()">‚õ∂</button>
        <button class="btn-secret" onclick="openPasswordMenu()">üîí</button>
    </div>

    <!-- MENUS (Hidden by default) -->
    <div id="accountMenu" class="overlay hidden">
        <h1>LOGIN</h1>
        <div class="garage-container">
            <input type="text" id="accName" class="pass-input" placeholder="USERNAME">
            <input type="password" id="accPass" class="pass-input" placeholder="PASSWORD">
            <div id="accMsg" style="height:20px; color:red; font-size:12px;"></div>
        </div>
        <div style="display:flex;">
            <button class="btn-menu" onclick="loginAccount()">ENTER</button>
            <button class="btn-menu" onclick="closeAccountMenu()">CANCEL</button>
        </div>
    </div>

    <div id="pinMenu" class="overlay hidden">
        <h1>SECURITY</h1>
        <div class="garage-container">
            <p style="color:#0ff">PIN CODE:</p>
            <input type="text" id="pinInput" class="pass-input" maxlength="4">
            <div id="pinMsg" style="height:20px; color:red; font-size:12px;"></div>
        </div>
        <div style="display:flex;">
            <button class="btn-menu" onclick="checkPin()">OK</button>
            <button class="btn-menu" onclick="closePinMenu()">CANCEL</button>
        </div>
    </div>

    <div id="cheatMenu" class="overlay hidden">
        <h1>HACKER PANEL</h1>
        <div class="cheat-box">
            <div class="cheat-row"><span>GOD MODE</span><span id="cheat-god" class="cheat-toggle" onclick="toggleCheat('god')">[OFF]</span></div>
            <div class="cheat-row"><span>SPEED HACK</span><span id="cheat-speed" class="cheat-toggle" onclick="toggleCheat('speed')">[OFF]</span></div>
            <div class="cheat-row"><span>HITBOXES</span><span id="cheat-hitbox" class="cheat-toggle" onclick="toggleCheat('hitbox')">[OFF]</span></div>
            <div class="cheat-row"><span>RAINBOW</span><span id="cheat-rainbow" class="cheat-toggle" onclick="toggleCheat('rainbow')">[OFF]</span></div>
            <div class="cheat-row" style="margin-top:10px; font-size:18px; color:#aaa; cursor:pointer;" onclick="unlockAll()">[UNLOCK ALL SKINS]</div>
            <div class="cheat-row" style="font-size:18px; color:#aaa; cursor:pointer;" onclick="completeAllLevels()">[COMPLETE LEVELS]</div>
        </div>
        <button class="btn-menu" onclick="closeCheatMenu()" style="border-color:#0f0; color:#0f0; margin-top:20px;">DISCONNECT</button>
    </div>

    <div id="passwordMenu" class="overlay hidden">
        <h1>LOGIN</h1>
        <input type="text" id="passInput" class="pass-input" placeholder="PASSWORD">
        <div id="passError" style="height:20px; color:red;"></div>
        <div style="margin-top:10px;">
            <button class="btn-menu" onclick="checkPassword()">OK</button>
            <button class="btn-menu" onclick="closePasswordMenu()">BACK</button>
        </div>
    </div>

    <div id="achieveMenu" class="overlay hidden">
        <h2>ACHIEVEMENTS</h2>
        <div class="level-grid" id="ach-list" style="display:block;"></div>
        <button class="btn-menu" onclick="closeAchievements()">BACK</button>
    </div>

    <div id="settingsMenu" class="overlay hidden">
        <h1>SETTINGS</h1>
        <div class="garage-container">
            <button id="ctrl-toggle-btn" onclick="toggleControls()" style="width:200px;">MODE: PC</button>
        </div>
        <button class="btn-menu" onclick="closeSettings()">BACK</button>
    </div>

    <div id="slotsMenu" class="overlay hidden">
        <h1 id="slots-title">SLOTS</h1>
        <div class="garage-container" id="slots-container"></div>
        <button class="btn-menu" onclick="closeSlotsMenu()">BACK</button>
    </div>

    <div id="garageMenu" class="overlay hidden">
        <h1>GARAGE</h1>
        <div class="garage-container">
            <div style="color:#aaa; text-align:center;">COLOR</div>
            <div class="selection-row" id="color-selector"></div>
            <div style="color:#aaa; text-align:center; margin-top:5px;">ICON</div>
            <div class="selection-row" id="skin-selector"></div>
        </div>
        <button class="btn-menu" onclick="closeGarage()">OK</button>
    </div>

    <!-- HUDs -->
    <div id="editorHUD" class="hidden">
        <div id="editor-ui">
            <button onclick="setTool(1)">‚ñ≤</button>
            <button onclick="setTool(2)">‚ñ†</button>
            <button onclick="setTool(3)">üåÄ</button>
            <button onclick="setTool(4)">‚è©</button>
            <button onclick="setTool(6)">üü°</button>
            <button onclick="saveCustomLevel()" style="background:#afa">üíæ</button>
            <button onclick="exitToMenu()" style="background:#faa">‚úñ</button>
            <div class="info" id="pc-info">PC: LMB/RMB | Mob: Arrows</div>
        </div>
        <div id="mob-editor-controls" class="hidden">
            <button onclick="moveCam(-1)">‚Üê</button>
            <button onclick="moveCam(1)">‚Üí</button>
        </div>
    </div>

    <div id="mobile-play-overlay" class="hidden" onmousedown="handleInput(true)" onmouseup="handleInput(false)" ontouchstart="handleInput(true)" ontouchend="handleInput(false)">
        <button id="mob-pause" onmousedown="event.stopPropagation(); exitToMenu();" ontouchstart="event.stopPropagation(); exitToMenu();">MENU</button>
    </div>

    <div id="endMenu" class="overlay hidden">
        <h1 id="death-msg">CRASHED</h1>
        <div style="display:flex;">
            <button class="btn-menu" onclick="restartLevel()">RETRY</button>
            <button class="btn-menu" onclick="exitToMenu()">MENU</button>
        </div>
    </div>
</div>

<script>
    // --- CORE SETUP ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // Force fixed internal resolution for consistency
    const GAME_WIDTH = 800;
    const GAME_HEIGHT = 450;
    canvas.width = GAME_WIDTH;
    canvas.height = GAME_HEIGHT;

    const bgMusic = document.getElementById('bgMusic');

    // UI Refs
    const mainMenu = document.getElementById('mainMenu');
    const garageMenu = document.getElementById('garageMenu');
    const achieveMenu = document.getElementById('achieveMenu');
    const settingsMenu = document.getElementById('settingsMenu');
    const slotsMenu = document.getElementById('slotsMenu');
    const endMenu = document.getElementById('endMenu');
    const editorHUD = document.getElementById('editorHUD');
    const levelList = document.getElementById('level-list');
    const deathMsg = document.getElementById('death-msg');
    const cheatMenu = document.getElementById('cheatMenu');
    const passwordMenu = document.getElementById('passwordMenu');
    const accountMenu = document.getElementById('accountMenu');
    const pinMenu = document.getElementById('pinMenu');
    
    const starCountEl = document.getElementById('star-count');
    const coinCountEl = document.getElementById('coin-count');
    const btnAuth = document.getElementById('btn-auth');
    const ctrlToggleBtn = document.getElementById('ctrl-toggle-btn');

    // --- GAME DATA ---
    const COLORS = ['#00e676', '#ffeb3b', '#2979ff', '#ff1744', '#d500f9', '#00e5ff', '#ffffff', '#ff9900', '#8800ff', '#ff0088', '#00ffaa', '#aaaaaa'];
    const SKINS = [
        {id:0, name:"Box", unlock:"Free"},
        {id:1, name:"Creeper", unlock:"Collect 3 Coins"},
        {id:2, name:"Pro", unlock:"Get 5 Stars"},
        {id:3, name:"Smile", unlock:"Beat Level 1"}
    ];

    let userSettings = { 
        color: COLORS[0], skin: 0, controls: 'PC', stars: 0, coins: 0, 
        unlockedSkins: [0], completedLevels: [], isLoggedIn: false 
    };

    // --- SAVE SYSTEM ---
    function loadUserData() {
        const saved = localStorage.getItem('drevd_user_v2');
        if(saved) userSettings = Object.assign(userSettings, JSON.parse(saved));
        updateStatsUI();
        updateControlsUI();
        updateAuthButton();
    }
    function saveUserData() { localStorage.setItem('drevd_user_v2', JSON.stringify(userSettings)); updateStatsUI(); }
    function updateStatsUI() { starCountEl.innerText = userSettings.stars; coinCountEl.innerText = userSettings.coins; }
    
    // --- FULLSCREEN ---
    function toggleFullScreen() {
        if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(e=>{});
        else if (document.exitFullscreen) document.exitFullscreen();
    }

    // --- AUTHENTICATION ---
    function handleAuth() { if(userSettings.isLoggedIn) logoutAccount(); else openMenu('accountMenu'); }
    function openMenu(id) { document.querySelectorAll('.overlay').forEach(el => el.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
    function closeAccountMenu() { accountMenu.classList.add('hidden'); mainMenu.classList.remove('hidden'); }
    
    function loginAccount() {
        const name = document.getElementById('accName').value;
        const pass = document.getElementById('accPass').value;
        const msg = document.getElementById('accMsg');
        
        if(name === 'Andrevd' && pass === 'AndrevdSecret') {
            userSettings.stars = 99999999; userSettings.coins = 99999999; userSettings.isLoggedIn = true;
            updateStatsUI(); updateAuthButton(); alert("WELCOME CREATOR"); closeAccountMenu();
        } 
        else if (name === 'AndrevdAndArtzz' && pass === 'AndrevdAndArtzzTop') {
            accountMenu.classList.add('hidden'); pinMenu.classList.remove('hidden');
            document.getElementById('pinInput').value = '';
        } 
        else { msg.innerText = "INVALID CREDENTIALS"; }
    }

    function checkPin() {
        if(document.getElementById('pinInput').value === '2526') {
            userSettings.stars = "9999999999999999"; userSettings.coins = "9999999999999999"; userSettings.isLoggedIn = true;
            userSettings.unlockedSkins = [0,1,2,3]; saveUserData(); updateAuthButton();
            pinMenu.classList.add('hidden'); mainMenu.classList.remove('hidden');
            alert("GOD ACCOUNT ACTIVATED");
        } else { document.getElementById('pinMsg').innerText = "WRONG PIN"; }
    }
    function closePinMenu() { pinMenu.classList.add('hidden'); mainMenu.classList.remove('hidden'); }

    function logoutAccount() {
        if(confirm("LOG OUT? This will reset progress.")) {
            localStorage.removeItem('drevd_user_v2'); location.reload();
        }
    }
    function updateAuthButton() {
        btnAuth.innerText = userSettings.isLoggedIn ? "üë§ LOG OUT" : "üë§ LOG IN";
        btnAuth.style.color = userSettings.isLoggedIn ? "red" : "#00e5ff";
        btnAuth.style.borderColor = userSettings.isLoggedIn ? "red" : "#00e5ff";
    }

    // --- CHEATS ---
    let cheats = { god: false, speed: false, hitbox: false, rainbow: false };
    function openPasswordMenu() { openMenu('passwordMenu'); document.getElementById('passInput').value=''; document.getElementById('passError').innerText=''; }
    function closePasswordMenu() { passwordMenu.classList.add('hidden'); mainMenu.classList.remove('hidden'); }
    function checkPassword() {
        if(document.getElementById('passInput').value === "Andrevdtop") { openMenu('cheatMenu'); }
        else { document.getElementById('passError').innerText="WRONG PASSWORD"; }
    }
    function toggleCheat(c) {
        cheats[c] = !cheats[c];
        const el = document.getElementById(`cheat-${c}`);
        el.innerText = cheats[c] ? "[ON]" : "[OFF]"; el.classList.toggle('on', cheats[c]);
    }
    function unlockAll() { userSettings.unlockedSkins=[0,1,2,3]; saveUserData(); alert("Unlocked!"); }
    function completeAllLevels() { LEVELS.forEach((l,i) => { if(!userSettings.completedLevels.includes(i)) { userSettings.completedLevels.push(i); userSettings.stars+=l.stars; } }); saveUserData(); alert("Levels Completed!"); initMenu(); }
    function closeCheatMenu() { cheatMenu.classList.add('hidden'); mainMenu.classList.remove('hidden'); }

    // --- ACHIEVEMENTS ---
    const ACHIEVEMENTS = [
        {id: "win1", name: "First Steps", desc: "Pass Level 1", check: ()=>userSettings.completedLevels.includes(0), reward: "Skin: Smile", rId: 3},
        {id: "rich", name: "Rich", desc: "Collect 3 Coins", check: ()=>userSettings.coins>=3, reward: "Skin: Creeper", rId: 1},
        {id: "pro", name: "Star Master", desc: "Get 5 Stars", check: ()=>userSettings.stars>=5, reward: "Skin: Pro", rId: 2}
    ];
    function checkAchievements() {
        let changed = false;
        ACHIEVEMENTS.forEach(ach => {
            if(ach.check() && !userSettings.unlockedSkins.includes(ach.rId)) {
                userSettings.unlockedSkins.push(ach.rId); alert(`ACHIEVEMENT: ${ach.name}`); changed=true;
            }
        });
        if(changed) saveUserData();
    }
    function openAchievements() {
        openMenu('achieveMenu');
        const list = document.getElementById('ach-list'); list.innerHTML = '';
        ACHIEVEMENTS.forEach(ach => {
            let u = userSettings.unlockedSkins.includes(ach.rId);
            let item = document.createElement('div');
            item.style = `padding:10px; border:1px solid #444; margin-bottom:5px; background:${u?'#1a331a':'#222'}; border-color:${u?'#0f0':'#444'}`;
            item.innerHTML = `<div><b>${ach.name}</b></div><div style="font-size:12px;color:#aaa">${ach.desc}</div><div style="font-size:10px;color:${u?'#0f0':'#777'}">${ach.reward}</div>`;
            list.appendChild(item);
        });
    }
    function closeAchievements() { achieveMenu.classList.add('hidden'); mainMenu.classList.remove('hidden'); }

    // --- LEVELS ---
    const MUSIC_TRACKS = {
        techno: "gspd.mp3",
        fast: "https://commondatastorage.googleapis.com/codeskulptor-demos/riceracer_assets/music/race1.ogg",
        epic: "https://commondatastorage.googleapis.com/codeskulptor-assets/week7-brrring.m4a",
        demon: "https://commondatastorage.googleapis.com/codeskulptor-demos/pyman_assets/eaten.ogg"
    };
    const LEVELS = [
        { name: "Genesis", diff: "Easy", stars: 3, track: "techno", data: [{x:5,y:0,t:2},{x:6,y:0,t:2},{x:7,y:0,t:2},{x:10,y:2,t:6},{x:12,y:0,t:1},{x:16,y:0,t:2},{x:17,y:1,t:2},{x:22,y:0,t:1},{x:26,y:0,t:4},{x:32,y:0,t:2},{x:32,y:1,t:2},{x:38,y:0,t:1},{x:45,y:0,t:5},{x:50,y:0,t:2},{x:50,y:1,t:1},{x:55,y:0,t:1},{x:56,y:0,t:1}] },
        { name: "Coin Rush", diff: "Normal", stars: 5, track: "epic", data: [{x:5,y:0,t:2},{x:8,y:0,t:3},{x:10,y:3,t:6},{x:15,y:4,t:2},{x:18,y:1,t:6},{x:20,y:2,t:2},{x:25,y:5,t:2},{x:30,y:1,t:2},{x:32,y:3,t:6},{x:35,y:4,t:2},{x:40,y:0,t:3},{x:45,y:0,t:1},{x:48,y:0,t:1},{x:52,y:0,t:2},{x:52,y:1,t:1}] },
        { name: "Speed Run", diff: "Hard", stars: 8, track: "fast", data: [{x:3,y:0,t:4},{x:8,y:0,t:1},{x:14,y:0,t:2},{x:18,y:0,t:1},{x:24,y:1,t:2},{x:30,y:0,t:3},{x:35,y:5,t:2},{x:40,y:0,t:2},{x:45,y:5,t:2},{x:50,y:0,t:3},{x:55,y:0,t:5},{x:60,y:0,t:1},{x:61,y:0,t:1},{x:62,y:0,t:1}] },
        { name: "Demon Hell", diff: "Insane", stars: 14, track: "demon", data: [{x:5,y:0,t:4},{x:8,y:0,t:1},{x:9,y:0,t:1},{x:10,y:0,t:1},{x:12,y:2,t:6},{x:15,y:0,t:2},{x:15,y:1,t:1},{x:20,y:0,t:3},{x:25,y:1,t:2},{x:25,y:4,t:2},{x:30,y:0,t:2},{x:30,y:5,t:2},{x:32,y:3,t:6},{x:38,y:0,t:3},{x:42,y:0,t:1},{x:43,y:0,t:1},{x:44,y:0,t:1},{x:50,y:0,t:2},{x:50,y:1,t:2},{x:50,y:2,t:6},{x:55,y:0,t:1},{x:56,y:0,t:1}] }
    ];

    // --- GAME ENGINE ---
    const BLOCK_SIZE = 40; const GRAVITY = 0.65; const JUMP_FORCE = -10.8; const SHIP_GRAVITY = 0.35; const SHIP_LIFT = -0.45;
    let animationId = null, gameState = 'MENU', currentLevelData = [], currentLevelIndex = -1, currentSlotId = 0, cameraX = 0, currentSpeed = 6.0, particles = [], isHolding = false, editorScrollX = 0, selectedTool = 1, sessionCoins = 0;
    let player = { x: 0, y: 0, dy: 0, angle: 0, width: 30, height: 30, mode: 'CUBE', onGround: false, isDead: false, color: '#00e676', skinId: 0, endX: 0 };

    // Optimized Audio
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function sfx(type) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;
        if(type==='jump') { osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(300, now+0.1); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now+0.1); }
        else if(type==='coin') { osc.type='sine'; osc.frequency.setValueAtTime(600, now); osc.frequency.linearRampToValueAtTime(1200, now+0.1); gain.gain.setValueAtTime(0.1, now); }
        else if(type==='crash') { osc.type='sawtooth'; osc.frequency.setValueAtTime(100, now); gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.01, now+0.3); }
        osc.start(now); osc.stop(now+(type==='crash'?0.3:0.1));
    }

    function init() { loadUserData(); initMenu(); ctx.fillStyle='#000'; ctx.fillRect(0,0,800,450); }

    function initMenu() {
        levelList.innerHTML = '';
        LEVELS.forEach((lvl, index) => {
            let btn = document.createElement('div'); btn.className = 'level-card';
            let starsEarned = userSettings.completedLevels.includes(index) ? `‚≠ê${lvl.stars}` : '';
            btn.innerHTML = `<div class="lvl-header"><span>${lvl.name}</span><span class="diff-${lvl.diff}">${lvl.diff}</span></div><div class="lvl-sub"><span>${starsEarned}</span><span>Stars: ${lvl.stars}</span></div>`;
            btn.onclick = () => startLevel(index);
            levelList.appendChild(btn);
        });
        let custom = document.createElement('div'); custom.className = 'level-card';
        custom.innerHTML = `<div class="lvl-header"><span style="color:#0ff">My Levels</span><span>USER</span></div>`;
        custom.onclick = () => openSlotsMenu(true); levelList.appendChild(custom);
        initGarage();
    }

    function initGarage() {
        const cc = document.getElementById('color-selector'); const sc = document.getElementById('skin-selector');
        cc.innerHTML = ''; sc.innerHTML = '';
        COLORS.forEach(c => {
            let b = document.createElement('div'); b.className = 'color-btn'; b.style.background = c;
            if(c === userSettings.color) b.classList.add('active');
            b.onclick = () => { userSettings.color = c; saveUserData(); initGarage(); };
            cc.appendChild(b);
        });
        SKINS.forEach(s => {
            let b = document.createElement('div'); let unlocked = userSettings.unlockedSkins.includes(s.id);
            b.className = `skin-btn ${unlocked?'':'locked'}`;
            if(s.id === userSettings.skin) b.classList.add('active');
            let cvs = document.createElement('canvas'); cvs.width=40; cvs.height=40;
            if(unlocked) drawAvatar(cvs.getContext('2d'), 20, 20, 30, s.id, userSettings.color, 0, 'CUBE');
            b.appendChild(cvs);
            b.onclick = () => { if(unlocked) { userSettings.skin = s.id; saveUserData(); initGarage(); } else alert(`LOCKED! ${s.unlock}`); };
            sc.appendChild(b);
        });
    }

    function toggleControls() { userSettings.controls = userSettings.controls === 'PC' ? 'MOBILE' : 'PC'; saveUserData(); updateControlsUI(); }
    function updateControlsUI() {
        ctrlToggleBtn.innerText = `MODE: ${userSettings.controls}`;
        document.getElementById('pc-info').style.display = userSettings.controls === 'MOBILE' ? 'none' : 'block';
    }
    function openSettings() { openMenu('settingsMenu'); updateControlsUI(); }
    function closeSettings() { settingsMenu.classList.add('hidden'); mainMenu.classList.remove('hidden'); }
    function openGarage() { openMenu('garageMenu'); }
    function closeGarage() { garageMenu.classList.add('hidden'); mainMenu.classList.remove('hidden'); }

    // Slots & Editor
    function openSlotsMenu(play) { openMenu('slotsMenu'); const c=document.getElementById('slots-container'); c.innerHTML=''; 
        for(let i=0;i<3;i++){
            let key=`drevd_custom_${i}`, d=localStorage.getItem(key), ex=d&&JSON.parse(d).length>0;
            let b=document.createElement('button'); b.className='btn-slot'; b.innerHTML=`<span>SLOT ${i+1}</span>${ex?'<span style="color:#0f0">DATA</span>':'<span style="color:#555">EMPTY</span>'}`;
            b.onclick=()=>{ currentSlotId=i; if(play&&!ex){if(confirm("Empty. Create?")) openEditor(i);} else if(play) startLevel('custom'); else openEditor(i); };
            c.appendChild(b);
        }
    }
    function closeSlotsMenu() { slotsMenu.classList.add('hidden'); mainMenu.classList.remove('hidden'); }

    function startLevel(idx) {
        if(animationId) cancelAnimationFrame(animationId);
        let trackKey = "track1";
        if (idx === 'custom') {
            const saved = localStorage.getItem(`drevd_custom_${currentSlotId}`);
            currentLevelData = saved ? JSON.parse(saved) : [];
        } else {
            currentLevelData = JSON.parse(JSON.stringify(LEVELS[idx].data));
            trackKey = LEVELS[idx].track;
        }
        currentLevelIndex = idx;
        
        // Find end
        let maxX = 0; currentLevelData.forEach(o => { if(o.x > maxX) maxX = o.x; });
        player.endX = (maxX * BLOCK_SIZE) + 600;
        
        currentLevelData.forEach(o => o.collected = false); sessionCoins = 0;

        document.querySelectorAll('.overlay').forEach(el=>el.classList.add('hidden'));
        document.getElementById('editorHUD').classList.add('hidden');
        
        const mobPlay = document.getElementById('mobile-play-overlay');
        if(userSettings.controls === 'MOBILE') mobPlay.classList.remove('hidden'); else mobPlay.classList.add('hidden');

        player.color = userSettings.color; player.skinId = userSettings.skin;
        resetPlayer(); particles = []; gameState = 'PLAY';
        
        bgMusic.src = MUSIC_TRACKS[trackKey] || MUSIC_TRACKS.techno;
        bgMusic.volume = 0.4; bgMusic.currentTime = 0; bgMusic.play().catch(e=>{});
        
        loop();
    }

    function resetPlayer() {
        player.x=100; player.y=GAME_HEIGHT-50-30; player.dy=0; player.angle=0; player.mode='CUBE'; player.isDead=false; player.onGround=true; cameraX=0; isHolding=false; currentSpeed=cheats.speed?10:6;
    }

    function restartLevel() { startLevel(currentLevelIndex); }
    function exitToMenu() {
        if(animationId) cancelAnimationFrame(animationId);
        gameState = 'MENU';
        document.querySelectorAll('.overlay').forEach(el=>el.classList.add('hidden'));
        document.getElementById('mobile-play-overlay').classList.add('hidden');
        document.getElementById('editorHUD').classList.add('hidden');
        mainMenu.classList.remove('hidden');
        bgMusic.pause();
        ctx.fillStyle='#000'; ctx.fillRect(0,0,GAME_WIDTH,GAME_HEIGHT);
        initMenu();
    }

    function loop() {
        if(gameState === 'PLAY') { update(); draw(); animationId = requestAnimationFrame(loop); }
        else if (gameState === 'EXPLODING') { drawExplosion(); animationId = requestAnimationFrame(loop); }
        else if (gameState === 'EDITOR') { drawEditor(); animationId = requestAnimationFrame(loop); }
    }

    function update() {
        // Physics
        if (player.mode === 'CUBE') {
            player.dy += GRAVITY * (cheats.gravity?-1:1);
            if(isHolding && player.onGround) { player.dy = JUMP_FORCE*(cheats.gravity?-1:1); player.onGround = false; sfx('jump'); }
            if(!player.onGround) player.angle += 0.15; else player.angle = Math.round(player.angle/(Math.PI/2))*(Math.PI/2);
        } else {
            let lift = isHolding ? SHIP_LIFT : SHIP_GRAVITY;
            if(cheats.gravity) lift = isHolding ? -SHIP_LIFT : -SHIP_GRAVITY;
            player.dy += lift;
            if(player.dy > 8) player.dy = 8; if(player.dy < -8) player.dy = -8;
            player.angle = player.dy * 0.1;
        }
        
        player.y += player.dy;
        player.x += (cheats.speed ? 12 : currentSpeed);
        cameraX = player.x - 200;

        // Particles
        if(particles.length < 50 && Math.random()>0.5) particles.push(new Particle(player.x, player.y+15, player.color, 'trail'));
        if(particles.length > 50) particles.shift();

        // Floor / Ceiling check
        const groundY = GAME_HEIGHT - 50;
        if(!cheats.gravity) {
            if(player.y + player.height > groundY) { player.y = groundY - player.height; player.dy = 0; player.onGround = true; } else player.onGround = false;
        } else {
            if(player.y < 0) { player.y = 0; player.dy = 0; player.onGround = true; } else player.onGround = false;
        }

        if(player.x > player.endX) { winLevel(); return; }
        checkCollisions(groundY);
    }

    function checkCollisions(groundY) {
        let pRect = {l: player.x+8, r: player.x+player.width-8, t: player.y+8, b: player.y+player.height-8};
        
        // Optim: Only check nearby objects
        let startIdx = Math.max(0, Math.floor((player.x - 100) / BLOCK_SIZE) - 5);
        
        for(let i=0; i<currentLevelData.length; i++) {
            let obj = currentLevelData[i];
            let ox = obj.x * BLOCK_SIZE; 
            
            // Render distance check for collision
            if(ox < cameraX - 100) continue;
            if(ox > cameraX + GAME_WIDTH + 100) break; // Sorted by X usually, optimization

            let oy = groundY - (obj.y * BLOCK_SIZE) - BLOCK_SIZE;

            // Coin
            if(obj.t === 6 && !obj.collected) {
                if(rectIntersect(player.x, player.x+30, player.y, player.y+30, ox, ox+40, oy, oy+40)) {
                    obj.collected = true; sessionCoins++; sfx('coin');
                }
                continue;
            }

            if(cheats.god) continue;

            // Spike
            if(obj.t === 1) { 
                if(rectIntersect(pRect.l, pRect.r, pRect.t, pRect.b, ox+10, ox+30, oy+10, oy+40)) crash();
            }
            // Block
            else if (obj.t === 2) {
                if(rectIntersect(player.x+2, player.x+28, player.y+2, player.y+28, ox, ox+40, oy, oy+40)) {
                    if(!cheats.gravity) {
                        if(player.dy > 0 && pRect.b <= oy+20) { player.y = oy - player.height; player.dy = 0; player.onGround = true; player.angle = Math.round(player.angle/(Math.PI/2))*(Math.PI/2); }
                        else if (player.mode === 'SHIP' && player.dy < 0 && pRect.t >= oy+20) { player.y = oy + 40; player.dy = 0; }
                        else if (player.mode === 'SHIP' && player.dy > 0 && pRect.b <= oy+20) { player.y = oy - player.height; player.dy = 0; }
                        else crash();
                    } else { crash(); } // Simplified gravity flip crash on blocks
                }
            }
            // Portal / Speed
            else if (obj.t === 3 && rectIntersect(player.x, player.x+30, player.y, player.y+30, ox, ox+40, oy, oy+40)) player.mode = player.mode === 'CUBE' ? 'SHIP' : 'CUBE';
            else if (obj.t === 4 && rectIntersect(player.x, player.x+30, player.y, player.y+30, ox, ox+40, oy, oy+40)) currentSpeed = 8.5;
            else if (obj.t === 5 && rectIntersect(player.x, player.x+30, player.y, player.y+30, ox, ox+40, oy, oy+40)) currentSpeed = 6.0;
        }
    }

    function rectIntersect(l1, r1, t1, b1, l2, r2, t2, b2) { return !(l2 > r1 || r2 < l1 || t2 > b1 || b2 < t1); }

    function crash() {
        if(player.isDead) return;
        player.isDead = true; gameState = 'EXPLODING'; sfx('crash'); bgMusic.pause();
        for(let i=0; i<30; i++) particles.push(new Particle(player.x+15, player.y+15, player.color, 'explode'));
        setTimeout(() => { openMenu('endMenu'); }, 1000);
    }

    function winLevel() {
        gameState = 'GAMEOVER'; bgMusic.pause();
        if(currentLevelIndex !== -1 && !userSettings.completedLevels.includes(currentLevelIndex)) {
            userSettings.completedLevels.push(currentLevelIndex);
            userSettings.stars = Number(userSettings.stars) + LEVELS[currentLevelIndex].stars;
        }
        userSettings.coins = Number(userSettings.coins) + sessionCoins;
        saveUserData(); checkAchievements();
        deathMsg.innerText = `COMPLETE!\n+${sessionCoins} Coins`; deathMsg.style.color = "#0f0";
        openMenu('endMenu');
    }

    function draw() {
        ctx.clearRect(0,0, GAME_WIDTH, GAME_HEIGHT);
        // Static BG for performance
        ctx.fillStyle = player.mode === 'CUBE' ? '#1a1a2e' : '#2c0000';
        ctx.fillRect(0,0, GAME_WIDTH, GAME_HEIGHT);

        ctx.save(); ctx.translate(-cameraX, 0); drawLevel(GAME_HEIGHT-50);
        
        for(let i=particles.length-1; i>=0; i--) { 
            particles[i].update(); particles[i].draw(ctx); 
            if(particles[i].life<=0) particles.splice(i,1); 
        }
        
        drawAvatar(ctx, player.x+15, player.y+15, 30, player.skinId, player.color, player.angle, player.mode);
        if(cheats.hitbox) { ctx.strokeStyle='#0f0'; ctx.strokeRect(player.x, player.y, 30, 30); }
        ctx.restore();
    }

    function drawExplosion() {
        ctx.clearRect(0,0, GAME_WIDTH, GAME_HEIGHT); ctx.fillStyle='#300'; ctx.fillRect(0,0,GAME_WIDTH,GAME_HEIGHT);
        ctx.save(); ctx.translate(-cameraX, 0); drawLevel(GAME_HEIGHT-50);
        for(let i=particles.length-1; i>=0; i--) { particles[i].update(); particles[i].draw(ctx); if(particles[i].life<=0) particles.splice(i,1); }
        ctx.restore();
    }

    function drawLevel(groundY) {
        ctx.fillStyle = '#000'; ctx.fillRect(cameraX, groundY, GAME_WIDTH, 50);
        ctx.fillStyle = '#fff'; ctx.fillRect(cameraX, groundY, GAME_WIDTH, 2);

        // Optimization: draw only visible blocks
        for(let obj of currentLevelData) {
            let ox = obj.x * BLOCK_SIZE;
            if(ox < cameraX - 100) continue;
            if(ox > cameraX + GAME_WIDTH + 100) break; // Stop drawing if off screen

            let oy = groundY - (obj.y * BLOCK_SIZE) - BLOCK_SIZE;
            
            if(cheats.hitbox) { ctx.strokeStyle = 'red'; ctx.strokeRect(ox, oy, 40, 40); }

            if(obj.t===1) { ctx.fillStyle='#111'; ctx.beginPath(); ctx.moveTo(ox,oy+40); ctx.lineTo(ox+20,oy); ctx.lineTo(ox+40,oy+40); ctx.fill(); ctx.strokeStyle='#f00'; ctx.stroke(); }
            else if(obj.t===2) { ctx.fillStyle='#000'; ctx.fillRect(ox,oy,40,40); ctx.strokeStyle='#0ff'; ctx.strokeRect(ox,oy,40,40); }
            else if(obj.t===3) { ctx.strokeStyle='#0f0'; ctx.beginPath(); ctx.arc(ox+20,oy+20,20,0,7); ctx.stroke(); }
            else if(obj.t===4) { ctx.fillStyle='orange'; ctx.fillText('>>', ox+10,oy+25); }
            else if(obj.t===5) { ctx.fillStyle='cyan'; ctx.fillText('>', ox+15,oy+25); }
            else if(obj.t===6 && !obj.collected) { ctx.fillStyle='gold'; ctx.beginPath(); ctx.arc(ox+20,oy+20,15,0,7); ctx.fill(); ctx.strokeStyle='#fff'; ctx.stroke(); }
        }
    }

    function drawAvatar(ctx, x, y, size, skinId, color, angle, mode) {
        ctx.save(); ctx.translate(x, y); ctx.rotate(angle);
        let drawColor = color;
        if(cheats.rainbow) { let hue = (Date.now()/5)%360; drawColor = `hsl(${hue},100%,50%)`; }
        ctx.shadowBlur = 10; ctx.shadowColor = drawColor; ctx.fillStyle = drawColor;
        let s = size;
        if (mode === 'SHIP') {
            ctx.beginPath(); ctx.moveTo(s/2, 0); ctx.lineTo(-s/3, s/3); ctx.lineTo(-s/3, -s/3); ctx.fill();
            ctx.fillStyle='rgba(0,0,0,0.5)'; ctx.beginPath(); ctx.moveTo(s/6,0); ctx.lineTo(-s/6, s/6); ctx.lineTo(-s/6, -s/6); ctx.fill();
        } else {
            ctx.fillRect(-s/2, -s/2, s, s); ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.strokeRect(-s/2, -s/2, s, s);
            ctx.fillStyle = '#000';
            if(skinId===1) { ctx.fillRect(-5,-5,10,10); ctx.fillRect(-10,-10,5,5); ctx.fillRect(5,-10,5,5); }
            else if(skinId===2) ctx.fillRect(-15,-5,30,10);
            else if(skinId===3) { ctx.beginPath(); ctx.arc(-7,-7,3,0,7); ctx.fill(); ctx.beginPath(); ctx.arc(7,-7,3,0,7); ctx.fill(); ctx.beginPath(); ctx.arc(0,5,7,0,3.14); ctx.stroke(); }
        }
        ctx.restore();
    }

    class Particle {
        constructor(x,y,c,t) { this.x=x; this.y=y; this.c=c; this.t=t; this.l=1.0; this.vx=(Math.random()-0.5)*(t==='explode'?10:2); this.vy=(Math.random()-0.5)*(t==='explode'?10:2); this.s=Math.random()*(t==='explode'?6:4)+2; }
        update() { this.x+=this.vx; this.y+=this.vy; this.l-=(this.t==='explode'?0.02:0.05); if(this.t==='trail') this.s*=0.9; }
        draw(ctx) { ctx.globalAlpha=Math.max(0,this.l); ctx.fillStyle=cheats.rainbow?`hsl(${Math.random()*360},100%,50%)`:this.c; ctx.fillRect(this.x,this.y,this.s,this.s); ctx.globalAlpha=1.0; }
    }

    // --- CONTROLS ---
    function handleInput(down) { if(gameState==='PLAY') isHolding=down; }
    window.addEventListener('keydown', e => { if(e.code==='Space'||e.code==='ArrowUp') handleInput(true); });
    window.addEventListener('keyup', e => { if(e.code==='Space'||e.code==='ArrowUp') handleInput(false); });
    canvas.addEventListener('mousedown', e => { if(gameState==='PLAY') handleInput(true); else if(gameState==='EDITOR') handleEditorClick(e); });
    canvas.addEventListener('mouseup', () => handleInput(false));
    
    // --- EDITOR ---
    function openEditor(slotId) {
        if(animationId) cancelAnimationFrame(animationId);
        gameState='EDITOR'; currentSlotId=slotId;
        const key = `drevd_custom_${slotId}`;
        currentLevelData = localStorage.getItem(key) ? JSON.parse(localStorage.getItem(key)) : [];
        editorScrollX=0;
        openMenu('dummy'); // hide others
        document.getElementById('editorHUD').classList.remove('hidden');
        if(userSettings.controls==='MOBILE') document.getElementById('mob-editor-controls').classList.remove('hidden');
        bgMusic.pause(); loop();
    }
    
    function drawEditor() {
        ctx.clearRect(0,0, GAME_WIDTH, GAME_HEIGHT);
        let gy = GAME_HEIGHT-50;
        ctx.fillStyle='#222'; ctx.fillRect(0,0,GAME_WIDTH,GAME_HEIGHT);
        let off = editorScrollX%BLOCK_SIZE;
        ctx.strokeStyle='#444'; ctx.beginPath(); for(let i=0;i<21;i++) { ctx.moveTo(i*40-off,0); ctx.lineTo(i*40-off,gy); } ctx.stroke();
        ctx.fillStyle='#000'; ctx.fillRect(0,gy,GAME_WIDTH,50);
        
        for(let obj of currentLevelData) {
            let px = obj.x*BLOCK_SIZE-editorScrollX; let py=gy-obj.y*BLOCK_SIZE-BLOCK_SIZE;
            if(px>-40 && px<GAME_WIDTH) {
                if(obj.t===1) { ctx.fillStyle='rgba(255,0,0,0.5)'; ctx.beginPath(); ctx.moveTo(px,py+40); ctx.lineTo(px+20,py); ctx.lineTo(px+40,py+40); ctx.fill(); }
                else if(obj.t===6) { ctx.fillStyle='yellow'; ctx.beginPath(); ctx.arc(px+20,py+20,15,0,7); ctx.fill(); }
                else ctx.fillStyle='rgba(0,255,255,0.5)'; ctx.fillRect(px,py,40,40);
            }
        }
    }

    function getMousePos(evt) {
        var rect = canvas.getBoundingClientRect();
        return { x: (evt.clientX - rect.left) * (canvas.width / rect.width), y: (evt.clientY - rect.top) * (canvas.height / rect.height) };
    }

    function handleEditorClick(e, isRight) {
        let m = getMousePos(e);
        let mx = m.x + editorScrollX;
        let my = m.y;
        let gx = Math.floor(mx/40);
        let gy = Math.floor((GAME_HEIGHT-50-my)/40);
        if(gy<0||gy>9) return;
        currentLevelData = currentLevelData.filter(o=>!(o.x===gx&&o.y===gy));
        if(!isRight) currentLevelData.push({x:gx,y:gy,t:selectedTool});
    }

    function setTool(t) { selectedTool=t; }
    function moveCam(d) { editorScrollX+=d*40; if(editorScrollX<0) editorScrollX=0; }
    function saveCustomLevel() { localStorage.setItem(`drevd_custom_${currentSlotId}`, JSON.stringify(currentLevelData)); alert("Saved!"); }
    window.addEventListener('keydown', e => { if(gameState==='EDITOR') { if(e.code==='ArrowRight') editorScrollX+=20; if(e.code==='ArrowLeft') editorScrollX=Math.max(0,editorScrollX-20); if(e.key>='1'&&e.key<='6') selectedTool=parseInt(e.key); } });

    init();
</script>
</body>
</html>
